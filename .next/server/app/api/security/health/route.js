"use strict";(()=>{var e={};e.id=641,e.ids=[641],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},1026:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>y,requestAsyncStorage:()=>v,routeModule:()=>g,serverHooks:()=>S,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{GET:()=>d,OPTIONS:()=>m,POST:()=>h});var a=r(9303),n=r(8716),o=r(3131),i=r(7070),c=r(8605);r(4770);let l=new Map,u=(0,c.createRateLimit)({windowMs:6e4,maxRequests:30,message:"Too many health check requests"});function p(e){let t=e.headers.get("x-api-key"),s=e.headers.get("authorization"),a=t||s?.replace("Bearer ","");if(!a)return{valid:!1,reason:"Missing API key"};let n=process.env.SECURITY_API_KEY;if(!n)return{valid:!1,reason:"Security monitoring not configured"};let o=r(4770);try{if(!o.timingSafeEqual(Buffer.from(a,"utf8"),Buffer.from(n,"utf8")))return{valid:!1,reason:"Invalid API key"};return{valid:!0}}catch(e){return{valid:!1,reason:"Authentication error"}}}async function d(e){try{let t=(0,c.validateRequest)(e);if(!t.valid)return i.NextResponse.json({success:!1,error:"Invalid request",reason:t.reason},{status:400});let r=await u(e);if(!r.success)return i.NextResponse.json({success:!1,error:r.error},{status:r.statusCode,headers:{"Retry-After":r.retryAfter?.toString()||"60"}});let s=p(e);if(!s.valid)return i.NextResponse.json({success:!1,error:"Authentication failed",reason:s.reason},{status:401});let a=function(){let e=[],t=[],r={blockedIPs:0,totalViolations:0,averageReputationScore:0,highRiskIPs:0},s=0,a=0;l.forEach((t,n)=>{a++,s+=t.score,r.totalViolations+=t.violations,t.blocked&&r.blockedIPs++,t.score>=5&&(r.highRiskIPs++,e.push(`High-risk IP detected: ${n} (score: ${t.score})`))}),r.averageReputationScore=a>0?s/a:0;let n="healthy";return r.blockedIPs>10||r.highRiskIPs>5?(n="critical",t.push("Consider implementing additional IP blocking measures")):(r.blockedIPs>5||r.highRiskIPs>2)&&(n="warning",t.push("Monitor IP reputation trends closely")),r.averageReputationScore>3&&(n="critical",t.push("High average IP reputation score indicates widespread abuse")),a>1e3&&t.push("Consider implementing IP reputation cleanup for old entries"),{status:n,issues:e,recommendations:t,metrics:r}}(),n={rateLimitStoreSize:global.rateLimitStore?.size||0,securityEventStoreSize:global.securityEventStore?.size||0,ipReputationStoreSize:global.ipReputationStore?.size||0,lastCleanup:global.lastCleanupTime||null,nextCleanup:global.nextCleanupTime||null},o={environmentVariables:{hasSecurityApiKey:!!process.env.SECURITY_API_KEY,hasResendApiKey:!!process.env.RESEND_API_KEY,hasStripeSecretKey:!!process.env.STRIPE_SECRET_KEY,hasSupabaseUrl:!!process.env.NEXT_PUBLIC_SUPABASE_URL,hasProductionNodeEnv:!0},securityHeaders:{hstsEnabled:!0,cspEnabled:!0,frameOptionsEnabled:!0,contentTypeOptionsEnabled:!0},apiSecurity:{rateLimitingEnabled:!0,inputValidationEnabled:!0,authenticationEnabled:!0,corsEnabled:!0}},d=(()=>{let e=100,t=o.environmentVariables,r=Object.values(t).filter(Boolean).length;return e-=20-4*r,"critical"===a.status?e-=30:"warning"===a.status&&(e-=15),a.metrics.blockedIPs>50&&(e-=10),a.metrics.highRiskIPs>20&&(e-=10),a.metrics.averageReputationScore>5?e-=20:a.metrics.averageReputationScore>3&&(e-=10),Math.max(0,Math.min(100,e))})();return i.NextResponse.json({success:!0,data:{health:a,metrics:n,checklist:o,score:{overall:d,grade:d>=95?"A+":d>=90?"A":d>=80?"B":d>=70?"C":d>=60?"D":"F",breakdown:{environmentSecurity:4*Object.values(o.environmentVariables).filter(Boolean).length,systemHealth:"healthy"===a.status?30:"warning"===a.status?15:0,threatLevel:a.metrics.blockedIPs>50?10:20,ipReputation:a.metrics.averageReputationScore>5?10:a.metrics.averageReputationScore>3?20:30}},timestamp:new Date().toISOString(),uptime:process.uptime(),version:{node:process.version,platform:process.platform,environment:"production"}}},{headers:{"X-RateLimit-Remaining":r.remaining?.toString()||"0","X-RateLimit-Reset":new Date(r.resetTime).toISOString(),"X-Content-Type-Options":"nosniff","X-Frame-Options":"DENY","Cache-Control":"no-store, must-revalidate"}})}catch(e){return console.error("Security health check error:",e),i.NextResponse.json({success:!1,error:"Failed to retrieve security health information"},{status:500})}}async function h(e){try{let t=(0,c.validateRequest)(e);if(!t.valid)return i.NextResponse.json({success:!1,error:"Invalid request",reason:t.reason},{status:400});let s=await u(e);if(!s.success)return i.NextResponse.json({success:!1,error:s.error},{status:s.statusCode,headers:{"Retry-After":s.retryAfter?.toString()||"60"}});let a=p(e);if(!a.valid)return i.NextResponse.json({success:!1,error:"Authentication failed",reason:a.reason},{status:401});let{action:n}=await e.json();switch(n){case"reset-reputation":if(global.ipReputationStore)return global.ipReputationStore.clear(),i.NextResponse.json({success:!0,message:"IP reputation data reset successfully",timestamp:new Date().toISOString()});break;case"export-events":let{getSecurityStats:o}=r(8605),l=o();return i.NextResponse.json({success:!0,data:{events:l,exportTime:new Date().toISOString(),totalEvents:l.totalEvents}});default:return i.NextResponse.json({success:!1,error:"Unknown action",availableActions:["reset-reputation","export-events"]},{status:400})}}catch(e){return console.error("Security health admin action error:",e),i.NextResponse.json({success:!1,error:"Failed to execute admin action"},{status:500})}}async function m(e){let t=e.headers.get("origin"),r=t&&["https://peycheff.com","https://www.peycheff.com"].includes(t);return new i.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":r?t:"null","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-API-Key, X-Requested-With","Access-Control-Allow-Credentials":"true","Access-Control-Max-Age":"86400",Vary:"Origin"}})}let g=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/security/health/route",pathname:"/api/security/health",filename:"route",bundlePath:"app/api/security/health/route"},resolvedPagePath:"/Users/ivan/Code/peycheff.com/app/api/security/health/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:v,staticGenerationAsyncStorage:f,serverHooks:S}=g,R="/api/security/health/route";function y(){return(0,o.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:f})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[216,592],()=>r(1026));module.exports=s})();
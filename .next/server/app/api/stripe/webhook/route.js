"use strict";(()=>{var e={};e.id=757,e.ids=[757],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},1568:e=>{e.exports=require("zlib")},9419:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>k,requestAsyncStorage:()=>x,routeModule:()=>z,serverHooks:()=>R,staticGenerationAsyncStorage:()=>w});var o={};r.r(o),r.d(o,{GET:()=>S,POST:()=>E});var n=r(9303),s=r(8716),a=r(3131),i=r(7070),c=r(1059),p=r(337),u=r(2723),l=r(5192),d=r(8605);let m=new c.Z(process.env.STRIPE_SECRET_KEY||"",{apiVersion:"2025-08-27.basil"}),g=process.env.NEXT_PUBLIC_SUPABASE_URL&&process.env.SUPABASE_SERVICE_ROLE_KEY?(0,p.eI)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY):null,y=new u.R(process.env.RESEND_API_KEY||"test_key"),_=(0,d.createRateLimit)(d.RATE_LIMITS["/api/whop"]),b={"checkout.session.completed":l.z.object({id:l.z.string(),object:l.z.literal("checkout.session"),customer:l.z.string().optional(),customer_email:l.z.string().optional(),metadata:l.z.record(l.z.string(),l.z.string()).optional(),payment_status:l.z.enum(["paid","unpaid","no_payment_required"]),total_amount:l.z.number(),currency:l.z.string(),created:l.z.number(),success_url:l.z.string().optional(),cancel_url:l.z.string().optional(),payment_intent:l.z.string().optional(),subscription:l.z.string().optional()}),"payment_intent.succeeded":l.z.object({id:l.z.string(),object:l.z.literal("payment_intent"),amount:l.z.number(),currency:l.z.string(),customer:l.z.string().optional(),metadata:l.z.record(l.z.string(),l.z.string()).optional(),status:l.z.string(),created:l.z.number(),receipt_email:l.z.string().optional()}),"payment_intent.payment_failed":l.z.object({id:l.z.string(),object:l.z.literal("payment_intent"),amount:l.z.number(),currency:l.z.string(),customer:l.z.string().optional(),metadata:l.z.record(l.z.string(),l.z.string()).optional(),status:l.z.string(),last_payment_error:l.z.object({message:l.z.string(),type:l.z.string()}).optional(),created:l.z.number()}),"invoice.payment_succeeded":l.z.object({id:l.z.string(),object:l.z.literal("invoice"),customer:l.z.string(),payment_intent:l.z.string().optional(),subscription:l.z.string().optional(),total:l.z.number(),currency:l.z.string(),status:l.z.string(),created:l.z.number(),metadata:l.z.record(l.z.string(),l.z.string()).optional()}),"customer.subscription.created":l.z.object({id:l.z.string(),object:l.z.literal("subscription"),customer:l.z.string(),status:l.z.string(),current_period_start:l.z.number(),current_period_end:l.z.number(),created:l.z.number(),metadata:l.z.record(l.z.string(),l.z.string()).optional()})};async function h(e){try{let t=await e.text(),r=e.headers.get("stripe-signature");if(!r)return{valid:!1,error:"Missing Stripe signature"};if(!process.env.STRIPE_WEBHOOK_SECRET)return{valid:!1,error:"Stripe webhook secret not configured"};let o=m.webhooks.constructEvent(t,r,process.env.STRIPE_WEBHOOK_SECRET);if(!o.id||!o.type)return{valid:!1,error:"Invalid webhook event structure"};if(Date.now()-1e3*o.created>9e5)return{valid:!1,error:"Webhook event too old (possible replay attack)"};return{valid:!0,event:o}}catch(e){return console.error("Stripe webhook validation error:",e),{valid:!1,error:e instanceof Error?e.message:"Unknown validation error"}}}async function f(e,t){if(!g)return console.log("Supabase not configured, skipping database storage"),{success:!0,data:null,note:"Database storage skipped"};try{let{data:r,error:o}=await g.from("orders").upsert({id:e.id||`stripe_${e.payment_intent||e.id}`,order_number:e.metadata?.order_number||`STRIPE_${Date.now()}`,platform:"stripe",status:function(e){switch(e){case"checkout.session.completed":case"payment_intent.succeeded":case"invoice.payment_succeeded":return"completed";case"payment_intent.payment_failed":return"failed";default:return"pending"}}(t),amount:e.total_amount||e.amount||e.total,currency:e.currency,customer_email:e.customer_email||e.receipt_email,customer_name:e.metadata?.customer_name,payment_intent_id:e.payment_intent||e.id,payment_method:e.payment_method_types?.[0]||"card",metadata:{stripe_event_type:t,stripe_event_id:e.id,customer:e.customer,...e.metadata},created_at:new Date(1e3*e.created).toISOString(),updated_at:new Date().toISOString()}).select();if(o)return console.error("Database error:",o),{success:!1,error:o.message};return console.log("Payment event stored:",r),{success:!0,data:r}}catch(e){return console.error("Store payment event error:",e),{success:!1,error:e.message}}}async function v(e,t){let r=e.customer_email||e.receipt_email;if(!r)return console.log("No email provided, skipping confirmation"),{success:!1,error:"No email address"};try{let o=e.metadata?.product_name||"Product/Service",n=e.total_amount||e.amount||e.total,s=new Intl.NumberFormat("en-US",{style:"currency",currency:e.currency?.toUpperCase()||"USD"}).format((n||0)/100),a={subject:`Payment Confirmation - ${o}`,html:`
        <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center;">
            <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 600;">Payment Successful!</h1>
            <p style="color: rgba(255,255,255,0.9); margin: 15px 0 0 0; font-size: 18px;">Thank you for your payment</p>
          </div>

          <div style="background: #f8f9fa; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
            <h2 style="color: #1a1a1a; margin: 0 0 20px 0; font-size: 20px; font-weight: 600;">Payment Details</h2>
            <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e5e7eb;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span style="color: #1a1a1a; font-weight: 600; font-size: 18px;">${o}</span>
                <span style="color: #10b981; font-weight: 700; font-size: 18px;">${s}</span>
              </div>
              <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f3f4f6; font-size: 14px; color: #6b7280;">
                <strong>Payment ID:</strong> ${e.payment_intent||e.id}<br>
                <strong>Date:</strong> ${new Date(1e3*e.created).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}<br>
                <strong>Status:</strong> ${t.replace("."," ").toUpperCase()}
              </div>
            </div>
          </div>

          <div style="background: white; padding: 25px; border: 1px solid #e5e7eb; border-radius: 8px;">
            <h2 style="color: #1a1a1a; margin: 0 0 15px 0; font-size: 18px; font-weight: 600;">What's Next?</h2>
            <ul style="color: #374151; line-height: 1.6; margin: 0; padding-left: 20px;">
              <li style="margin-bottom: 8px;">You'll receive a receipt via email</li>
              <li style="margin-bottom: 8px;">Check your email for product access instructions</li>
              <li style="margin-bottom: 8px;">For subscriptions, you'll be notified before renewal</li>
              <li>Questions? Just reply to this email</li>
            </ul>
          </div>

          <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px;">
            <p style="margin: 0 0 10px 0;">Thank you for supporting my work!</p>
            <p style="margin: 0;">
              Ivan Peycheff â€¢ <a href="mailto:ivan@peycheff.com" style="color: #0A84FF; text-decoration: none;">ivan@peycheff.com</a>
            </p>
          </div>
        </div>
      `},i=await y.emails.send({from:"Ivan Peycheff <ivan@peycheff.com>",to:r,subject:a.subject,html:a.html});return console.log("Payment confirmation email sent:",i),{success:!0,data:i}}catch(e){return console.error("Email sending failed:",e),{success:!1,error:e.message}}}async function E(e){try{let t;let r=(0,d.getClientIP)(e),o=(0,d.validateRequest)(e);if(!o.valid)return await (0,d.logSecurityEvent)({type:d.SECURITY_EVENTS.SUSPICIOUS_REQUEST,ip:r,url:e.url,userAgent:e.headers.get("user-agent"),method:e.method,reason:o.reason}),i.NextResponse.json({error:"Invalid request",reason:o.reason},{status:400});let n=await _(e);if(!n.success)return await (0,d.logSecurityEvent)({type:d.SECURITY_EVENTS.RATE_LIMIT_EXCEEDED,ip:r,url:e.url,userAgent:e.headers.get("user-agent"),method:e.method,count:n.remaining}),i.NextResponse.json({error:n.error},{status:n.statusCode,headers:{"Retry-After":n.retryAfter?.toString()||"3600"}});let s=await e.text(),a=new i.NextRequest(e.url,{method:e.method,headers:Object.fromEntries(e.headers),body:s}),c=await h(a);if(!c.valid)return await (0,d.logSecurityEvent)({type:d.SECURITY_EVENTS.INVALID_WEBHOOK_SIGNATURE,ip:r,url:e.url,userAgent:e.headers.get("user-agent"),reason:c.error}),i.NextResponse.json({error:c.error},{status:401});let p=c.event;console.log(`Stripe webhook received: ${p.type}`);let u=b[p.type];if(!u)return console.log(`Unhandled event type: ${p.type}`),i.NextResponse.json({received:!0});try{t=u.parse(p.data.object)}catch(e){return console.error(`Invalid event data for ${p.type}:`,e),i.NextResponse.json({error:"Invalid event data structure"},{status:400})}let l={...t,stripe_event_id:p.id,stripe_event_type:p.type},m=await f(l,p.type);if(m.success||console.error("Failed to store payment event:",m.error),p.type.includes("succeeded")||p.type.includes("completed")){let e=await v(l,p.type);e.success||console.error("Failed to send confirmation email:",e.error)}try{let e={event:"stripe_webhook_processed",properties:{event_type:p.type,payment_intent:t.payment_intent,customer:t.customer,amount:t.amount||t.total_amount,currency:t.currency},timestamp:new Date().toISOString()};await fetch("https://peycheff.com/api/analytics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(e){console.error("Analytics tracking error:",e)}return console.log(`Successfully processed ${p.type} webhook`),i.NextResponse.json({received:!0})}catch(t){return console.error("Stripe webhook error:",t),await (0,d.logSecurityEvent)({type:d.SECURITY_EVENTS.SUSPICIOUS_REQUEST,ip:(0,d.getClientIP)(e),url:e.url,userAgent:e.headers.get("user-agent"),method:e.method,reason:"Webhook processing error",error:t instanceof Error?t.message:"Unknown error"}),i.NextResponse.json({error:"Webhook processing failed"},{status:500})}}async function S(){return i.NextResponse.json({status:"active",service:"stripe-webhook",timestamp:new Date().toISOString(),configured:{stripe:!!process.env.STRIPE_SECRET_KEY,webhook_secret:!!process.env.STRIPE_WEBHOOK_SECRET,resend:!!process.env.RESEND_API_KEY,supabase:!!process.env.SUPABASE_SERVICE_ROLE_KEY},supported_events:Object.keys(b)})}let z=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/Users/ivan/Code/peycheff.com/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:x,staticGenerationAsyncStorage:w,serverHooks:R}=z,I="/api/stripe/webhook/route";function k(){return(0,a.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:w})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[216,592],()=>r(9419));module.exports=o})();